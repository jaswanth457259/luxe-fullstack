# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# pr-checks.yml ‚Äî Pull Request Quality Gates
# Triggers: Every pull request opened/updated to dev, staging, main
# Ensures: Code quality, security, correct PR format before merge
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

name: üîé PR Quality Gates

on:
  pull_request:
    branches: [dev, staging, main]
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  # ‚îÄ‚îÄ PR Title Convention Check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  pr-lint:
    name: üìù PR Title Convention
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: üîç Lint PR Title (Conventional Commits)
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            test
            chore
            ci
            perf
          requireScope: false
          subjectPattern: ^.{5,72}$
          subjectPatternError: |
            PR title must be between 5 and 72 characters.
            Example: "feat: add product search filter"

  # ‚îÄ‚îÄ Detect What Changed ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  changes:
    name: üîé Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      docker: ${{ steps.filter.outputs.docker }}

    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'
            docker:
              - 'docker/**'
              - 'backend/Dockerfile'
              - 'frontend/Dockerfile'

  # ‚îÄ‚îÄ Backend PR Checks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  backend-pr-check:
    name: üîß Backend PR Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true'

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpass
          MYSQL_DATABASE: luxe_test
        ports: ["3306:3306"]
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-retries=5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: ‚úÖ Compile
        working-directory: ./backend
        run: mvn compile -q

      - name: üß™ Test
        working-directory: ./backend
        run: mvn test
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/luxe_test
          SPRING_DATASOURCE_USERNAME: root
          SPRING_DATASOURCE_PASSWORD: testpass
          APP_JWT_SECRET: TestSecretKey_AtLeast256BitsLong_ForHMACSHA256!!

      - name: üìä Coverage Gate (minimum 60%)
        working-directory: ./backend
        run: |
          mvn jacoco:report
          # Parse coverage percentage
          COVERAGE=$(python3 -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('target/site/jacoco/jacoco.xml')
          counters = [c for c in tree.getroot().iter('counter') if c.attrib.get('type') == 'LINE']
          if counters:
              c = counters[0]
              missed, covered = int(c.attrib['missed']), int(c.attrib['covered'])
              total = missed + covered
              print(f'{covered/total*100:.1f}' if total > 0 else '0')
          else:
              print('0')
          " 2>/dev/null || echo "0")
          echo "üìä Line coverage: ${COVERAGE}%"

  # ‚îÄ‚îÄ Frontend PR Checks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  frontend-pr-check:
    name: ‚öõÔ∏è  Frontend PR Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true'

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: üì¶ Install
        working-directory: ./frontend
        run: npm ci

      - name: üîç ESLint
        working-directory: ./frontend
        run: npm run lint

      - name: üß™ Tests
        working-directory: ./frontend
        run: npm test -- --run

      - name: üèóÔ∏è Build Check
        working-directory: ./frontend
        run: npm run build
        env:
          VITE_API_BASE_URL: http://localhost:8080/api

  # ‚îÄ‚îÄ 4-Member Code Review Requirement ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  review-requirement:
    name: üë• Code Review Requirements
    runs-on: ubuntu-latest

    steps:
      - name: ‚úÖ Check Review Requirements
        run: |
          TARGET="${{ github.base_ref }}"
          echo "Target branch: $TARGET"
          if [ "$TARGET" = "main" ]; then
            echo "‚ö†Ô∏è  PRs to main require 2 approvals (enforced via branch protection)"
            echo "   Team leads: Member 3 (DevOps) + Member 4 (PM) must approve"
          elif [ "$TARGET" = "staging" ]; then
            echo "‚ÑπÔ∏è  PRs to staging require 1 approval"
          else
            echo "‚ÑπÔ∏è  PRs to dev require 1 approval"
          fi

  # ‚îÄ‚îÄ PR Summary Comment ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  pr-summary:
    name: üí¨ PR Summary
    runs-on: ubuntu-latest
    needs: changes

    steps:
      - name: üìù Comment PR Summary
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('ü§ñ PR Analysis'));
            
            const backendChanged = '${{ needs.changes.outputs.backend }}' === 'true';
            const frontendChanged = '${{ needs.changes.outputs.frontend }}' === 'true';
            
            const body = `## ü§ñ PR Analysis

            | Area | Changed | Tests Required |
            |------|---------|----------------|
            | Backend (Spring Boot) | ${backendChanged ? '‚úÖ Yes' : '‚ûñ No'} | ${backendChanged ? 'JUnit + Mockito' : 'N/A'} |
            | Frontend (ReactJS) | ${frontendChanged ? '‚úÖ Yes' : '‚ûñ No'} | ${frontendChanged ? 'React Testing' : 'N/A'} |

            ### üåø Branch Flow
            \`${context.payload.pull_request.head.ref}\` ‚Üí \`${context.payload.pull_request.base.ref}\`

            ### ‚úÖ Checklist for Reviewer
            - [ ] Code follows team conventions
            - [ ] Tests are written/updated  
            - [ ] No hardcoded secrets or credentials
            - [ ] Swagger/API docs updated if endpoints changed
            - [ ] No breaking changes to existing APIs

            > ‚ö†Ô∏è **Merging to \`main\` requires 2 approvals** from team leads.`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
