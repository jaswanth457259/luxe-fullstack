# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ci.yml â€” Continuous Integration
# Triggers: Every push and pull request to dev, staging, main
# Runs: Backend tests (JUnit/Mockito) + Frontend tests + SonarQube analysis
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: ğŸ”¬ CI â€” Build & Test

on:
  push:
    branches: [dev, staging, main]
  pull_request:
    branches: [dev, staging, main]

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '18'

jobs:
  # â”€â”€ Backend: Compile, Test, Coverage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  backend-ci:
    name: ğŸ”§ Backend CI (Java + JUnit + Mockito)
    runs-on: ubuntu-latest

    services:
      # Spin up a real MySQL container for integration tests
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpassword
          MYSQL_DATABASE: luxe_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for SonarQube

      - name: â˜• Set Up Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ğŸ”¨ Build Backend
        working-directory: ./backend
        run: mvn clean compile -q

      - name: ğŸ§ª Run Unit Tests (JUnit 5 + Mockito)
        working-directory: ./backend
        run: mvn test
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/luxe_test
          SPRING_DATASOURCE_USERNAME: root
          SPRING_DATASOURCE_PASSWORD: testpassword
          APP_JWT_SECRET: TestSecretKey2026_AtLeast256BitsLongForHMACSHA256!!
          APP_JWT_EXPIRATION_MS: 3600000

      - name: ğŸ“Š Generate JaCoCo Code Coverage Report
        working-directory: ./backend
        run: mvn jacoco:report

      - name: ğŸ“‹ Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: JUnit Test Results
          path: backend/target/surefire-reports/*.xml
          reporter: java-junit

      - name: ğŸ” SonarQube Analysis
        working-directory: ./backend
        run: >
          mvn sonar:sonar
          -Dsonar.projectKey=luxe-ecommerce-backend
          -Dsonar.host.url=https://sonarcloud.io
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
          -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true   # Don't fail build if Sonar token not set

      - name: ğŸ“¦ Upload Coverage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-report
          path: backend/target/site/jacoco/

  # â”€â”€ Frontend: Install, Lint, Test, Build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  frontend-ci:
    name: âš›ï¸  Frontend CI (React + Vite)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Set Up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¦ Install Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ğŸ” ESLint Check
        working-directory: ./frontend
        run: npm run lint
        continue-on-error: false

      - name: ğŸ§ª Run Frontend Tests
        working-directory: ./frontend
        run: npm test -- --run
        env:
          CI: true

      - name: ğŸ—ï¸ Build Production Bundle
        working-directory: ./frontend
        run: npm run build
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || 'http://localhost:8080/api' }}

      - name: ğŸ“¦ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/
          retention-days: 7

  # â”€â”€ Docker Build Validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  docker-validate:
    name: ğŸ³ Docker Build Validation
    runs-on: ubuntu-latest
    needs: [backend-ci]

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Set Up Java for Maven Package
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ğŸ“¦ Package Backend JAR (skip tests)
        working-directory: ./backend
        run: mvn package -DskipTests -q

      - name: ğŸ³ Build Docker Image
        working-directory: ./backend
        run: |
          docker build -t luxe-backend:ci-${{ github.sha }} .
          echo "âœ… Docker image built successfully"

  # â”€â”€ Security Scan (OWASP + Trivy â€” as per PDF) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security-scan:
    name: ğŸ”’ Security Scan (OWASP + Trivy)
    runs-on: ubuntu-latest
    needs: [backend-ci]

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Set Up Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ğŸ›¡ï¸ OWASP Dependency Check
        working-directory: ./backend
        run: >
          mvn org.owasp:dependency-check-maven:check
          -DfailBuildOnCVSS=9
          -DsuppressionFile=../docs/owasp-suppressions.xml
        continue-on-error: true

      - name: ğŸ” Trivy Vulnerability Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './backend'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: ğŸ“¤ Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  # â”€â”€ Final Gate: All checks must pass â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci-gate:
    name: âœ… CI Gate (All checks passed)
    runs-on: ubuntu-latest
    needs: [backend-ci, frontend-ci, docker-validate]
    if: always()

    steps:
      - name: Check All Jobs Passed
        run: |
          if [[ "${{ needs.backend-ci.result }}" != "success" || \
                "${{ needs.frontend-ci.result }}" != "success" || \
                "${{ needs.docker-validate.result }}" != "success" ]]; then
            echo "âŒ One or more CI jobs failed!"
            exit 1
          fi
          echo "âœ… All CI checks passed! Safe to deploy."
